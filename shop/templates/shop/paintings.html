{% extends "base.html" %}
{% load staticfiles humanize i18n crispy_forms_tags %}
{% block content %}
<div id="carousel-container" class="af-square-buttons-carousel">
    <div class="row" id="carousel-item" style="height: inherit;">
        <div class="col-12 col-md-12 col-lg-6 col-xl-6 flex-center">
            <div>
                <h1 class="carousel-main-text">{% trans "당신의 작품을 맡겨보세요" %}</h1>
                <h6 class="carousel-sub-text">헤이글리에서 프로, 아마추어 작가분들의 멋진 작품을 국내외 미술 애호가분들께 소개해드립니다.</h6>
                <div class="carousel-btn-flex">
                    <button type="btn" class="my-btn-or mt-3" data-toggle="modal" data-target="#modal-sell">판매
                        의뢰하기</button>
                </div>
            </div>
        </div>
        <div id="carousel-img" style="background-image:url({% static 'img/sip.jpg' %})" class="carousel-img">
        </div>
    </div>
    <div class="row" id="carousel-item" style="height: inherit">
        <div class="col-12 col-md-12 col-lg-6 col-xl-6 flex-center">
            <div>
                <h1 class="carousel-main-text">{% trans "어디에서도 볼 수 없던 작품들" %}</h1>
                <h6 class="carousel-sub-text">다른 곳에서 볼 수 없던 프로, 아마추어 작가분들의 멋진 작품을 만나보세요.</h6>
                <div class="carousel-btn-flex">
                    <button type="btn" class="my-btn-or mt-3" data-toggle="modal" data-target="#modal-sell">구매
                        문의하기</button>
                </div>
            </div>
        </div>
        <div id="carousel-img2" style="background-image:url({% static 'img/sip.jpg' %})" class="carousel-img">
        </div>
    </div>
</div>
<div class="my-container">
    <div class="container">
        <div class="grid are-images-unloaded">
            <div class="grid__col-sizer"></div>
            <div class="grid__gutter-sizer"></div>
            {% for painting in paintings.object_list %}
            <div class="grid__item">
                <a href="{% url 'shop:paintingDetail' painting.slug %}">
                    <img src="{{painting.thumbnail.url}}">
                    <div class="main-description">
                        <h5 class="my-painting-title">{{painting.name}}</h5>
                        <p class="my-description-sub right">{{painting.painter.name}}</p>
                        <p class="my-description-bold left">₩ {{painting.price|intcomma}}</p>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
<div class="modal fade" id="modal-sell" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalCenterTitle">문의하기</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="sellfabForm" method="POST">
                    {% csrf_token %}
                    {{form|crispy}}
                    <button id="sellfabBtn" class="btn btn-primary" data-dismiss="modal">문의하기</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block js %}
<script>
    //-------------------------------------//
    // init Slick

    $(document).ready(function () {
        $('#carousel-container').slick({
            fade: true,
            dots: true,
        });
    }).ready(function() {
        $(".slick-slide>div").addClass("container");
    });

    //-------------------------------------//
    // init Masonry

    var $grid = $('.grid').masonry({
        itemSelector: 'none', // select none at first
        columnWidth: '.grid__col-sizer',
        gutter: '.grid__gutter-sizer',
        percentPosition: true,
        stagger: 30,
        // nicer reveal transition
        visibleStyle: { transform: 'translateY(0)', opacity: 1 },
        hiddenStyle: { transform: 'translateY(100px)', opacity: 0 },
    });

    // get Masonry instance
    var msnry = $grid.data('masonry');

    // initial items reveal
    $grid.imagesLoaded(function () {
        $grid.removeClass('are-images-unloaded');
        $grid.masonry('option', { itemSelector: '.grid__item' });
        var $items = $grid.find('.grid__item');
        $grid.masonry('appended', $items);
    });

    //-------------------------------------//
    // calculate number of pages and make page urls

    function getPageNumbers(num) {
        var pageNumbers = []
        for (i = 1; i < num; i++) {
            pageNumbers.push(i + 1)
        }
        return pageNumbers
    }

    var nextPageNumbers = getPageNumbers(parseInt('{{paintings.paginator.num_pages}}'))

    function getPaintingsPath() {
        var currentUrl = window.location.href
        var pageIndex = nextPageNumbers[this.loadCount];
        if (pageIndex) {
            return currentUrl + '?page=' + pageIndex;
        }
    }

    //-------------------------------------//
    // init Infinte Scroll

    var infScroll = $grid.infiniteScroll({
        path: getPaintingsPath,
        append: '.grid__item',
        outlayer: msnry,
        status: '.page-load-status',
        history: false,
    });

    infScroll.on('append.infiniteScroll', function(response, path, items) {
        //When imagesLoaded on progress
        //hide the next populated masonry grid untill it's evenrything ok
        $grid.imagesLoaded().progress(function() {
            //layout Masonry after each image loads
            $grid.addClass('are-images-unloaded');
            console.log("Append Item... wait the fix before show");
        });

        //When images loaded done event window.addEventListener
        $grid.imagesLoaded().done(function() {
            console.log("Done loading...");

            //Re-apply the layout masonry setting
            msnry.layout(); //the magic
            //Now it's fixed, so show the new (fixed) grid of masonry items
            $grid.removeClass('are-images-unloaded');
        });
    });

    //-------------------------------------//
    // send mail with ajax(sellfab)

    $("#sellfabBtn").click(function () {
        var formData = $("#sellfabForm").serialize();
        $.ajax({
            type: "POST",
            url: "{% url 'mail:sendEmail' %}",
            data: formData,
            success: onSuccess
        });
    });

    function onSuccess(data) {
        $.notify({
            message: '메일이 전송되었습니다.',
        }, {
                allow_dismiss: false,
                animate: {
                    enter: 'animated fadeInDown',
                    exit: 'animated fadeOutUp'
                },
                delay: 1500,
                type: 'success',
                template: '<div data-notify="container" class="my-noti mx-auto col-xs-11 col-sm-3 alert alert-{0}" role="alert">' +
                    '<button type="button" aria-hidden="true" class="close" data-notify="dismiss">×</button>' +
                    '<span data-notify="icon"></span> ' +
                    '<span data-notify="title">{1}</span> ' +
                    '<span data-notify="message">{2}</span>' +
                    '<div class="progress" data-notify="progressbar">' +
                    '<div class="progress-bar progress-bar-{0}" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"></div>' +
                    '</div>' +
                    '<a href="{3}" target="{4}" data-notify="url"></a>' +
                    '</div>'
            });
    };

    function resize_carousel() {
        $(".carousel-img").width(window.innerWidth / 2);
    }

    resize_carousel();

    window.addEventListener("resize", function () {
        resize_carousel();
    });
</script>
{% endblock %}